/**
 * このファイルはソース自動生成によって上書きされます。
 */
import { useCallback, useMemo } from 'react'
import { useMsgContext, useToastContext } from './Notification'
import { useHttpRequest } from './Http'
import { ItemKey, LocalRepositoryContextValue, LocalRepositoryStoredItem, SaveLocalItemHandler, getLocalRepositoryState } from './LocalRepository'
import * as AggregateType from '../autogenerated-types'

export const useLocalRepositoryCommitHandling = () => {
  const [, dispatchMsg] = useMsgContext()
  const [, dispatchToast] = useToastContext()
  const { post, httpDelete } = useHttpRequest()

  const saveHandlerMap = useMemo(() => new Map<string, SaveLocalItemHandler<any>>([
    ['参照先', async (localReposItem: LocalRepositoryStoredItem<AggregateType.参照先DisplayData>) => {
      const [{ item: saveItem }] = AggregateType.convert参照先ToLocalRepositoryItem(localReposItem.item)
      const state = getLocalRepositoryState(localReposItem)
      if (state === '+') {
        const url = `/api/参照先/create`
        const response = await post<AggregateType.参照先DisplayData>(url, saveItem)
        return { commit: response.ok }
    
      } else if (state === '*') {
        const url = `/api/参照先/update`
        const response = await post<AggregateType.参照先DisplayData>(url, saveItem)
        return { commit: response.ok }
    
      } else if (state === '-') {
        const url = `/api/参照先/delete`
        const response = await httpDelete(url, saveItem)
        return { commit: response.ok }
    
      } else {
        dispatchMsg(msg => msg.error(`'${saveItem}' の状態 '${state}' が不正です。`))
        return { commit: false }
      }
    }],
    ['親集約', async (localReposItem: LocalRepositoryStoredItem<AggregateType.親集約DisplayData>) => {
      const [{ item: saveItem }] = AggregateType.convert親集約ToLocalRepositoryItem(localReposItem.item)
      const state = getLocalRepositoryState(localReposItem)
      if (state === '+') {
        const url = `/api/親集約/create`
        const response = await post<AggregateType.親集約DisplayData>(url, saveItem)
        return { commit: response.ok }
    
      } else if (state === '*') {
        const url = `/api/親集約/update`
        const response = await post<AggregateType.親集約DisplayData>(url, saveItem)
        return { commit: response.ok }
    
      } else if (state === '-') {
        const url = `/api/親集約/delete`
        const response = await httpDelete(url, saveItem)
        return { commit: response.ok }
    
      } else {
        dispatchMsg(msg => msg.error(`'${saveItem}' の状態 '${state}' が不正です。`))
        return { commit: false }
      }
    }],
  ]), [post, httpDelete, dispatchMsg, dispatchToast])

  return useCallback(async (
    commit: LocalRepositoryContextValue['commit'],
    ...keys: { dataTypeKey: string, itemKey: ItemKey }[]
  ) => {
    const success = await commit(async localReposItem => {
      const handler = saveHandlerMap.get(localReposItem.dataTypeKey)
      if (!handler) {
        dispatchMsg(msg => msg.error(`データ型 '${localReposItem.dataTypeKey}' の保存処理が定義されていません。`))
        return { commit: false }
      }
      return await handler(localReposItem)
    }, ...keys)

    dispatchToast(msg => success
      ? msg.info('保存しました。')
      : msg.info('一部のデータの保存に失敗しました。'))

  }, [saveHandlerMap, dispatchMsg, dispatchToast])
}
