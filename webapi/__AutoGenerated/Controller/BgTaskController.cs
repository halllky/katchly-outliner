namespace Katchly {
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.EntityFrameworkCore;

    [ApiController]
    [Route("api/[controller]")]
    public partial class NIJOBackgroundTaskEntityController : ControllerBase {
        public NIJOBackgroundTaskEntityController(AutoGeneratedApplicationService applicationService) {
            _applicationService = applicationService;
        }

        private readonly AutoGeneratedApplicationService _applicationService;

        [HttpPost("schedule/{jobType}")]
        public virtual IActionResult Schedule(string? jobType, [FromBody] object? param) {
            if (string.IsNullOrWhiteSpace(jobType)) {
                return BadRequest("ジョブ種別を指定してください。");

            } else if (!_applicationService.TryScheduleJob(jobType, param, out var errors)) {
                return BadRequest(string.Join(Environment.NewLine, errors));

            } else {
                return Ok();
            }
        }

        [HttpGet("ls")]
        public virtual IActionResult Listup(
            [FromQuery] DateTime? since,
            [FromQuery] DateTime? until,
            [FromQuery] int? skip,
            [FromQuery] int? take) {

            var query = (IQueryable<BackgroundTaskEntity>)_applicationService.DbContext.NIJOBackgroundTaskEntityDbSet.AsNoTracking();

            // 絞り込み
            if (since != null) {
                var paramSince = since.Value.Date;
                query = query.Where(e => e.RequestTime >= paramSince);
            }
            if (until != null) {
                var paramUntil = until.Value.Date.AddDays(1);
                query = query.Where(e => e.RequestTime <= paramUntil);
            }

            // 順番
            query = query.OrderByDescending(e => e.RequestTime);

            // ページング
            if (skip != null) query = query.Skip(skip.Value);

            const int DEFAULT_PAGE_SIZE = 20;
            var pageSize = take ?? DEFAULT_PAGE_SIZE;
            query = query.Take(pageSize);

            return this.JsonContent(query.ToArray());
        }
    }
}
