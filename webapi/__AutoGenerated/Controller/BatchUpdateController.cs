namespace Katchly {
    using Microsoft.AspNetCore.Mvc;

    [ApiController]
    [Route("api/[controller]")]
    public partial class BatchUpdateController : ControllerBase {
        public BatchUpdateController(AutoGeneratedApplicationService applicationService) {
            _applicationService = applicationService;
        }

        private readonly AutoGeneratedApplicationService _applicationService;

        [HttpPost("")]
        public virtual IActionResult Index([FromBody] BatchUpdateFeature.Parameter parameter) {
            if (!BatchUpdateFeature.TryCreate(parameter, out var command, out var errors)) {
                return BadRequest($"パラメータが不正です。{Environment.NewLine}{string.Join(Environment.NewLine, errors)}");
            }

            using var tran = _applicationService.DbContext.Database.BeginTransaction();
            try {
                if (!command.Execute(_applicationService, out var errors2)) {
                    tran.Rollback();
                    return Problem($"一括更新に失敗しました。{Environment.NewLine}{string.Join(Environment.NewLine, errors2)}");
                }
                tran.Commit();
                return Ok();

            } catch (Exception ex) {
                tran.Rollback();
                return Problem(ex.ToString());
            }
        }
    }
}
